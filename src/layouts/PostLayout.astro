---
import BaseLayout from './BaseLayout.astro';
import { categoryMeta, type Category } from '../data/content-registry';

interface Props {
  title: string;
  description: string;
  category: string;
  contentType: string;
  date: string;
  readTime: string;
  featured: boolean;
}

const { title, description, category, contentType, date, readTime, featured } = Astro.props;
const catMeta = categoryMeta[category as Category] || { name: category, description: '', emoji: '&#128196;' };

const formattedDate = (() => {
  try {
    const d = new Date(date);
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  } catch {
    return date;
  }
})();

const siteUrl = 'https://hyuntech.ai.kr';
const pageUrl = `${siteUrl}/category/${category}/${Astro.url.pathname.split('/').filter(Boolean).pop()}/`;

const isoDate = (() => {
  try {
    return new Date(date).toISOString();
  } catch {
    return date;
  }
})();

const articleSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "datePublished": isoDate,
  "dateModified": isoDate,
  "author": { "@type": "Organization", "name": "HyunTech", "url": siteUrl },
  "publisher": {
    "@type": "Organization", "name": "HyunTech", "url": siteUrl,
    "logo": { "@type": "ImageObject", "url": `${siteUrl}/og-default.png` },
  },
  "mainEntityOfPage": { "@type": "WebPage", "@id": pageUrl },
});

const breadcrumbSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "홈", "item": siteUrl },
    { "@type": "ListItem", "position": 2, "name": catMeta.name, "item": `${siteUrl}/category/${category}/` },
    { "@type": "ListItem", "position": 3, "name": title },
  ],
});
---

<BaseLayout title={`${title} - HyunTech`} description={description} ogType="article" datePublished={isoDate} dateModified={isoDate}>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={articleSchema} />
    <script type="application/ld+json" set:html={breadcrumbSchema} />
  </Fragment>

  <div class="container">
    <div class="breadcrumb">
      <a href="/">홈</a> <span class="sep">/</span>
      <a href={`/category/${category}/`}>{catMeta.name}</a> <span class="sep">/</span>
      <span>{title}</span>
    </div>
  </div>

  <div class="container">
    <div class="article-header">
      <span class="badge badge-primary">{contentType}</span>
      {featured && <span class="badge badge-accent" style="margin-left:8px;">추천</span>}
      <h1>{title}</h1>
      {description && <p class="post-description">{description}</p>}
      <div class="article-meta">
        <span class="author">HyunTech 편집팀</span>
        <span class="divider">|</span>
        {date && <span>{formattedDate} 업데이트</span>}
        {readTime && (
          <>
            <span class="divider">|</span>
            <span>{readTime} 읽기</span>
          </>
        )}
      </div>
    </div>
  </div>

  <div class="container">
    <div class="article-layout">
      <div class="article-content">
        <slot />
      </div>

      <!-- Auto-generated Sidebar -->
      <aside class="sidebar" id="post-sidebar">
        <div class="sidebar-box sidebar-toc">
          <h3>목차</h3>
          <ul id="toc-list"></ul>
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>

<style>
  .post-description {
    font-size: 1.05rem;
    color: var(--text-secondary);
    line-height: 1.6;
    margin: -8px 0 16px;
  }

  /* ===== 표준 마크다운 요소 스타일 (Prose) ===== */

  /* 헤딩 */
  .article-content :global(h2) {
    font-size: 24px; font-weight: 700; margin: 40px 0 16px;
    padding-top: 24px; border-top: 1px solid var(--border-light);
    color: var(--text);
  }
  .article-content :global(h2:first-child) { margin-top: 0; padding-top: 0; border-top: none; }
  .article-content :global(h3) { font-size: 20px; font-weight: 700; margin: 32px 0 12px; color: var(--text); }
  .article-content :global(h4) { font-size: 16px; font-weight: 600; margin: 24px 0 8px; color: var(--text); }

  /* 본문 */
  .article-content :global(p) { margin-bottom: 16px; color: var(--text-secondary); line-height: 1.8; }
  .article-content :global(strong) { color: var(--text); font-weight: 700; }
  .article-content :global(em) { font-style: italic; }
  .article-content :global(del) { text-decoration: line-through; opacity: 0.6; }

  /* 링크 */
  .article-content :global(a) {
    color: var(--primary); text-decoration: underline;
    text-underline-offset: 2px; transition: color var(--transition);
  }
  .article-content :global(a:hover) { color: var(--primary-dark); }

  /* 리스트 */
  .article-content :global(ul) { margin-bottom: 16px; padding-left: 24px; }
  .article-content :global(ol) { margin-bottom: 16px; padding-left: 24px; }
  .article-content :global(li) { margin-bottom: 8px; color: var(--text-secondary); list-style: disc; line-height: 1.7; }
  .article-content :global(ol > li) { list-style: decimal; }

  /* 테이블 */
  .article-content :global(table) {
    width: 100%; border-collapse: collapse; margin: 24px 0;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); overflow: hidden;
    font-size: 14px;
  }
  .article-content :global(thead) { background: var(--bg-secondary); }
  .article-content :global(th) {
    padding: 14px 20px; text-align: left; font-weight: 600;
    color: var(--text-secondary); font-size: 13px;
    letter-spacing: 0.04em; border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .article-content :global(td) {
    padding: 14px 20px; border-bottom: 1px solid var(--border-light);
    vertical-align: middle; color: var(--text-secondary);
  }
  .article-content :global(tbody tr) { transition: background var(--transition); }
  .article-content :global(tbody tr:hover) { background: var(--bg-secondary); }
  .article-content :global(tbody tr:last-child td) { border-bottom: none; }

  /* 인용문 (blockquote) */
  .article-content :global(blockquote) {
    border-left: 4px solid var(--primary);
    background: var(--primary-light);
    border-radius: 0 var(--radius) var(--radius) 0;
    padding: 20px 24px; margin: 24px 0;
  }
  .article-content :global(blockquote p) { color: var(--text); margin: 0; }
  .article-content :global(blockquote strong) { color: var(--primary); }

  /* 코드 */
  .article-content :global(code) {
    background: var(--bg-secondary); padding: 2px 6px;
    border-radius: 4px; font-size: 0.9em; color: var(--primary);
  }
  .article-content :global(pre) {
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 20px 24px;
    overflow-x: auto; margin: 24px 0;
  }
  .article-content :global(pre code) {
    background: none; padding: 0; border-radius: 0;
    font-size: 14px; color: var(--text);
  }

  /* 이미지 */
  .article-content :global(img) {
    max-width: 100%; height: auto;
    border-radius: var(--radius-lg); margin: 24px 0;
    box-shadow: var(--shadow-sm);
  }

  /* 구분선 */
  .article-content :global(hr) {
    border: none; border-top: 1px solid var(--border);
    margin: 32px 0;
  }

  /* 체크박스 (to-do) */
  .article-content :global(input[type="checkbox"]) {
    margin-right: 8px; accent-color: var(--primary);
  }

  /* FAQ - details/summary (마크다운 toggle) */
  .article-content :global(details) {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); overflow: hidden;
    margin-bottom: 12px;
  }
  .article-content :global(summary) {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px; cursor: pointer; font-size: 16px;
    font-weight: 600; list-style: none; color: var(--text);
    transition: background var(--transition);
  }
  .article-content :global(summary::-webkit-details-marker) { display: none; }
  .article-content :global(summary::marker) { display: none; content: ''; }
  .article-content :global(summary:hover) { background: var(--bg-secondary); }
  .article-content :global(summary::after) {
    content: '';
    width: 20px; height: 20px; flex-shrink: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.3s ease;
  }
  .article-content :global(details[open] summary::after) { transform: rotate(180deg); }
  .article-content :global(details > :not(summary)) {
    padding: 0 24px 20px; font-size: 15px; color: var(--text-secondary); line-height: 1.7;
  }

  /* FAQ 카드 리스트 (.faq-list는 JS에서 동적으로 생성) */
  .article-content :global(.faq-list) { display: flex; flex-direction: column; gap: 12px; padding-bottom: 40px; }
  .article-content :global(.faq-item) {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); overflow: hidden;
  }
  .article-content :global(.faq-question) {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px; cursor: pointer; font-size: 16px;
    font-weight: 600; list-style: none; color: var(--text);
    transition: background var(--transition);
  }
  .article-content :global(.faq-question::-webkit-details-marker) { display: none; }
  .article-content :global(.faq-question:hover) { background: var(--bg-secondary); }
  .article-content :global(.faq-arrow) { color: var(--text-light); flex-shrink: 0; transition: transform 0.3s ease; }
  .article-content :global(.faq-item[open] .faq-arrow) { transform: rotate(180deg); }
  .article-content :global(.faq-answer-inner) {
    padding: 0 24px 20px; font-size: 15px; color: var(--text-secondary); line-height: 1.7;
  }

  /* Sidebar */
  .sidebar { position: sticky; top: 84px; }
  .sidebar-box {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius-lg); padding: 24px; margin-bottom: 20px;
  }
  .sidebar-box h3 {
    font-size: 15px; font-weight: 700; margin-bottom: 16px;
    padding-bottom: 12px; border-bottom: 1px solid var(--border-light);
  }
  .sidebar-toc :global(ul) { display: flex; flex-direction: column; gap: 8px; padding: 0; margin: 0; }
  .sidebar-toc :global(li) { list-style: none; margin: 0; }
  .sidebar-toc :global(li a) {
    font-size: 14px; color: var(--text-secondary); display: block;
    padding: 6px 12px; border-left: 2px solid transparent;
    border-radius: 0 var(--radius) var(--radius) 0; transition: all var(--transition);
    text-decoration: none;
  }
  .sidebar-toc :global(li a:hover),
  .sidebar-toc :global(li a.active) {
    color: var(--primary); background: var(--primary-light); border-left-color: var(--primary);
    font-weight: 600;
  }

  /* 반응형 테이블 래퍼 */
  .article-content :global(.table-wrapper) {
    overflow-x: auto; -webkit-overflow-scrolling: touch;
    margin: 24px 0;
  }

  @media (max-width: 1024px) {
    .sidebar { display: grid; grid-template-columns: 1fr; gap: 20px; position: static; }
  }
  @media (max-width: 768px) {
    .sidebar { position: static; }
    .article-content :global(table) { display: block; overflow-x: auto; }
  }
</style>

<script>
  // FAQ 패턴 변환: h2[FAQ/알아야할] 이후 h3+p 패턴을 FAQ 카드로 변환
  function buildFaq() {
    const content = document.querySelector('.article-content');
    if (!content) return;

    const headings = content.querySelectorAll('h2');
    for (const h2 of headings) {
      const text = h2.textContent.trim();
      if (!/알아야\s*할|FAQ|자주\s*묻는/i.test(text)) continue;

      // FAQ 섹션 발견 - h3+p 패턴 수집
      const faqList = document.createElement('div');
      faqList.className = 'faq-list';
      const toRemove = [];
      let el = h2.nextElementSibling;

      while (el && el.tagName !== 'H2') {
        if (el.tagName === 'H3') {
          const question = el.textContent.trim();
          const answerParts = [];
          let next = el.nextElementSibling;
          // h3 다음에 오는 p들을 답변으로 수집
          while (next && next.tagName !== 'H3' && next.tagName !== 'H2') {
            if (next.tagName === 'P') {
              answerParts.push(next.innerHTML);
            }
            toRemove.push(next);
            next = next.nextElementSibling;
          }
          toRemove.push(el);

          // FAQ 카드 생성
          const details = document.createElement('details');
          details.className = 'faq-item';
          const summary = document.createElement('summary');
          summary.className = 'faq-question';
          summary.innerHTML = question + '<svg class="faq-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>';
          const answer = document.createElement('div');
          answer.className = 'faq-answer-inner';
          answer.innerHTML = answerParts.join('<br>') || '';
          details.appendChild(summary);
          details.appendChild(answer);
          faqList.appendChild(details);

          el = next;
        } else {
          toRemove.push(el);
          el = el.nextElementSibling;
        }
      }

      // 기존 요소 제거 후 FAQ 리스트 삽입
      if (faqList.children.length > 0) {
        for (const node of toRemove) node.remove();
        h2.insertAdjacentElement('afterend', faqList);
      }
    }
  }

  // Auto-generate TOC from article headings
  function buildToc() {
    const content = document.querySelector('.article-content');
    const tocList = document.getElementById('toc-list');
    if (!content || !tocList) return;

    // 모든 h2에 id 부여 (없으면 생성)
    const allHeadings = content.querySelectorAll('h2, h3');
    allHeadings.forEach((h, idx) => {
      if (!h.id) {
        const text = h.textContent.trim();
        h.id = text.replace(/\s+/g, '-').replace(/[^\w가-힣-]/g, '').toLowerCase() || 'section-' + idx;
      }
    });

    const headings = content.querySelectorAll('h2[id]');
    headings.forEach(h => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '#' + h.id;
      a.textContent = h.textContent.trim();
      a.setAttribute('aria-label', '목차: ' + h.textContent.trim());
      li.appendChild(a);
      tocList.appendChild(li);
    });

    // Scroll-based active tracking
    const tocLinks = tocList.querySelectorAll('a');
    if (tocLinks.length === 0) return;

    const sectionIds = Array.from(tocLinks).map(link => link.getAttribute('href').replace('#', ''));
    const sections = sectionIds.map(id => document.getElementById(id)).filter(Boolean);

    function updateActive() {
      const scrollY = window.scrollY;
      const viewportHeight = window.innerHeight;
      const docHeight = document.documentElement.scrollHeight;

      if (scrollY + viewportHeight >= docHeight - 10) {
        tocLinks.forEach(link => link.classList.remove('active'));
        tocLinks[tocLinks.length - 1]?.classList.add('active');
        return;
      }

      let currentId = '';
      for (const section of sections) {
        const rect = section.getBoundingClientRect();
        if (rect.top <= 120) {
          currentId = section.id;
        }
      }

      tocLinks.forEach(link => {
        link.classList.toggle('active', link.getAttribute('href') === '#' + currentId);
      });
    }

    window.addEventListener('scroll', updateActive, { passive: true });
    updateActive();
  }

  // FAQ 먼저 변환 후 TOC 빌드
  buildFaq();
  buildToc();
</script>
